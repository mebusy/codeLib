<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0029)http://nand2tetris.org/08.php -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
	<title>The Elements of Computing Systems / Nisan &amp; Schocken</title>
		<link rel="stylesheet" type="text/css" href="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/style.css">
		<script type="text/javascript" src="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/jquery-1.7.1.min.js"></script>		
		<script type="text/javascript" src="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/popup.js"></script></head><body><div id="nand_popup" onmouseover="overPopup(true);" onmouseout="overPopup(false);" style="z-index: 200; top: 231px; left: 313px; display: none;">// This file is part of www.nand2tetris.org
// and the book "The Elements of Computing Systems"
// by Nisan and Schocken, MIT Press.
// File name: projects/08/ProgramFlow/FibonacciSeries/FibonacciSeries.vm

// Puts the first argument[0] elements of the Fibonacci series
// in the memory, starting in the address given in argument[1].
// Argument[0] and argument[1] are initialized by the test script 
// before this code starts running.

push argument 1
pop pointer 1           // that = argument[1]

push constant 0
pop that 0              // first element in the series = 0
push constant 1
pop that 1              // second element in the series = 1

push argument 0
push constant 2
sub
pop argument 0          // num_of_elements -= 2 (first 2 elements are set)

label MAIN_LOOP_START

push argument 0
if-goto COMPUTE_ELEMENT // if num_of_elements &gt; 0, goto COMPUTE_ELEMENT
goto END_PROGRAM        // otherwise, goto END_PROGRAM

label COMPUTE_ELEMENT

push that 0
push that 1
add
pop that 2              // that[2] = that[0] + that[1]

push pointer 1
push constant 1
add
pop pointer 1           // that += 1

push argument 0
push constant 1
sub
pop argument 0          // num_of_elements--

goto MAIN_LOOP_START

label END_PROGRAM
</div>		
	
	
		<div class="box">
					
				<a name="top"></a>
				<div class="topbar">
<img class="banner" src="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/banner.png" height="100px" alt="Banner">
<span class="titletext">From NAND to Tetris</span>
<span class="subtitletext">Building a Modern Computer From First
Principles</span>
</div>
				<div class="sidemenu">
					<a href="http://nand2tetris.org/" class="menu">Home</a><a href="http://nand2tetris.org/course.php" class="menu_selected">Course</a><a href="http://nand2tetris.org/book.php" class="menu">Book</a><a href="http://nand2tetris.org/software.php" class="menu">Software</a><a href="http://nand2tetris.org/terms.php" class="menu">License</a><a href="http://nand2tetris.org/papers.php" class="menu">Papers</a><a href="http://nand2tetris.org/media.php" class="menu">Talks</a><a href="http://nand2tetris.org/coolstuff.php" class="menu">Cool Stuff</a><a href="http://nand2tetris.org/about.php" class="menu">About</a><a href="http://nand2tetris.org/team.php" class="menu">Team</a><a href="https://docs.google.com/forms/d/e/1FAIpQLSeGtR3QyvmjMubq3ij3h7CBKvDSxd9nnHhkLVZR4YB5FVo8sA/viewform" target="_blank" "="" class="menu">Stay in Touch</a><a href="http://questions-and-answers-forum.32033.n3.nabble.com/" target="_blank" "="" class="menu">Q&amp;A</a>				</div>
			<div class="content">
			<h1>project 8: Virtual Machine II - Program Control</h1>
<span class="project_desc">Background</span>
<p class="project_text">
We continue building the <i>VM translator</i> - a program that translates programs written in the VM language into programs written in the Hack machine language. This is a respectable chunk of engineering, so we are doing it in two stages. Welcome to stage II.   
</p>

<span class="project_desc">Objective</span>
<p class="project_text">
Extend the basic VM translator built in project 7 into a full-scale VM translator. In particular, in project 7 we focused on handling the <i>stack arithmetic</i> and <i>memory access</i> commands of the VM language. We now turn to handle the VM language's <i>branching</i> and <i>function calling </i> commands.
</p>

<span class="project_desc">Contract</span>
<p class="project_text">
Write a full-scale VM-to-Hack translator, extending the basic translator developed in project 7, and conforming to the <i>VM Specification, Part II</i> (book section 8.2) and to the <i>Standard VM-on-Hack Mapping, Part II</i> (book section 8.3.1). Use your VM translator to translate he VM programs supplied below, yielding corresponding programs written in the Hack assembly language. When executed on the supplied <i>CPU emulator</i>, the translated code generated by your VM translator should deliver the results mandated by the test scripts and compare files supplied below.
</p>
Note that a VM program may span either a single <tt>.vm</tt> file or a directory containing one or more <tt>.vm</tt> files. In the former case, the VM translator is invoked using the command <tt>VMTranslator</tt> <i>fileName</i><tt>.vm</tt>. The translator creates an output file named <i>fileName</i><tt>.asm</tt>, which is stored in the same directory of the input file. In the latter case, the VM translator is invoked using <tt>VMTranslator</tt> <i>dirName</i>. The translator creates a single output file named <i>dirName</i><tt>.asm</tt>, which is stored in the same directory. This single file contains the assembly code resulting from translating <i>all</i> the <tt>.vm</tt> files in the input directory. The name of the input file or directory may contain a file path. If no path is specified, the VM translator operates on the current directory by default.
<p></p>

<span class="project_desc">Resources</span>
<p class="project_text">
The relevant reading for this project is chapter 8. You will need two tools: the programming language with which you will implement your VM translator, and the supplied <i>CPU emulator</i>. This emulator allows executing, and testing, on your PC, the machine code generated by your VM translator. Another tool that comes handy in this project is the supplied <i>VM emulator</i>. The VM emulator (described at the bottom of this page) allows experimenting with the supplied VM programs before setting out to write your VM translator.
</p> 

<span class="project_desc">Testing</span>
<p class="project_text">
We recommend completing the implementation of the VM translator in two stages. First, implement and test the translation of the VM language's <i>branching</i> commands. Next, implement and test the translation of the <i>function call and return</i> commands. This will allow you to unit-test your implementation incrementally, using the test programs supplied below.
</p>

<p class="project_text">
<b>Testing how the VM translator handles <i>branching commands</i>:</b>
</p> 

<table class="tests">
<tbody><tr class="tblheader"> 
	<td>Program</td>
	<td>Description</td>
	<td>Test Script</td>
</tr> 
<tr>
	<td> <span class="code">
	
	<a onmouseover="popup(&quot;projects/08/ProgramFlow/BasicLoop/BasicLoop.vm&quot;,true);"> BasicLoop.vm</a>
	
	</span> </td>
	<td> Computes the sum 1+2+...+ <i> n </i> and pushes the result onto the stack. This program tests the implementation of the VM language's branching commands <span class="code">goto</span> and <span class="code">if-goto</span>.</td>
	<td> <a onmouseover="popup(&quot;projects/08/ProgramFlow/BasicLoop/BasicLoopVME.tst&quot;,true);">
BasicLoopVME.tst </a><br>
<a onmouseover="popup(&quot;projects/08/ProgramFlow/BasicLoop/BasicLoop.tst&quot;,true);">
BasicLoop.tst </a><br>
 <a onmouseover="popup(&quot;projects/08/ProgramFlow/BasicLoop/BasicLoop.cmp&quot;,true);"> BasicLoop.cmp </a> 
</td>
</tr>
<tr>
	<td> <span class="code"> 
	
	<a onmouseover="popup(&quot;projects/08/ProgramFlow/FibonacciSeries/FibonacciSeries.vm&quot;,true);">FibonacciSeries.vm</a>
	
	</span> </td>
	<td> Computes and stores in memory the first <i>n</i> elements of the Fibonacci series. This typical array manipulation program provides a more challenging test of the VM's branching commands.</td>
	<td> <a onmouseover="popup(&quot;projects/08/ProgramFlow/FibonacciSeries/FibonacciSeriesVME.tst&quot;,true);"> FibonacciSeriesVME.tst </a><br>
<a onmouseover="popup(&quot;projects/08/ProgramFlow/FibonacciSeries/FibonacciSeries.tst&quot;,true);">FibonacciSeries.tst</a> <a onmouseover="popup(&quot;projects/08/ProgramFlow/FibonacciSeries/FibonacciSeries.cmp&quot;,true);"> FibonacciSeries.cmp </a></td>
</tr>
</tbody></table>

<p class="project_text">
	<b>Testing how the VM translator handles <i>function call and return commands</i>:</b>
</p>

<table class="tests">
<tbody><tr class="tblheader"> 
	<td>Program</td>
	<td>Description</td>
	<td>Test Script</td>
</tr> 
<tr> 
	<td> <span class="code">	
    <a onmouseover="popup(&quot;projects/08/FunctionCalls/SimpleFunction/SimpleFunction.vm&quot;,true);"> SimpleFunction.vm</a>	
	</span> </td>
	<td> Performs a simple calculation and returns the result. This program provides a basic test of the implementation of the VM commands <span class="code">function</span> and <span class="code">return</span>.</td>
	<td> <a onmouseover="popup(&quot;projects/08/FunctionCalls/SimpleFunction/SimpleFunctionVME.tst&quot;,true);"> SimpleFunctionVME.tst </a><br><a onmouseover="popup(&quot;projects/08/FunctionCalls/SimpleFunction/SimpleFunction.tst&quot;,true);"> SimpleFunction.tst </a> <a onmouseover="popup(&quot;projects/08/FunctionCalls/SimpleFunction/SimpleFunction.cmp&quot;,true);"> SimpleFunction.cmp </a> </td> 
</tr>

<tr>
<td> <u>NestedCall:</u> <br> <span class="code">
<a onmouseover="popup(&quot;projects/08/FunctionCalls/NestedCall/Sys.vm&quot;,true);"> Sys.vm </a> 
</span> <br><br>
An optional and intermediate test, which may be useful when <span class="code">SimpleFunction</span> (the previous test) passes but <span class="code">FibonacciElement</span> (the next test) fails.
</td>
<td>Tests several requirements of the function calling protocol. <br><br> For more information about this optional test, see <a href="http://nand2tetris.org/projects/08/FunctionCalls/NestedCall/NestedCall.html" target="_blank">this guide</a> and <a href="http://nand2tetris.org/projects/08/FunctionCalls/NestedCall/NestedCallStack.html" target="_blank">this stack diagram.</a> <br><br> Can be used with or without the VM bootstrap code.
</td><td>
<a onmouseover="popup(&quot;projects/08/FunctionCalls/NestedCall/NestedCallVME.tst&quot;,true);"> NestedCallVME.tst </a> <br>
<a onmouseover="popup(&quot;projects/08/FunctionCalls/NestedCall/NestedCall.tst&quot;,true);"> NestedCall.tst </a> <br>
<a onmouseover="popup(&quot;projects/08/FunctionCalls/NestedCall/NestedCall.cmp&quot;,true);">
NestedCall.cmp</a> </td>
</tr>

<tr>
<td> <u>FibonacciElement:</u> <br> <span class="code">
<a onmouseover="popup(&quot;projects/08/FunctionCalls/FibonacciElement/Main.vm&quot;,true);"> Main.vm </a>
<br>
<a onmouseover="popup(&quot;projects/08/FunctionCalls/FibonacciElement/Sys.vm&quot;,true);"> Sys.vm </a> 
</span> <br><br>
Since the program consists of more than one <span class="code">.vm </span> file, the entire directory must be translated. <br> <br>The translation should yield a single assembly file named <span class="code">FibonacciElement.asm</span>. <br> <br>See the note below for more information on handling multiple <span class="code">.vm </span> files.
</td>
<td>Tests the handling of the VM's function calling commands, the bootstrap section, and most of the other VM commands. The program directory consists of two files, as follows.
<br> <br>
<span class="code">Main.vm</span> contains one function named <span class="code">Main.fibonacci</span>. This recursive function returns the <i>n</i>'th element of the Fibonacci series, and is unrelated to the Fibonacci series program described previously in this project.
<br><br>
<span class="code">Sys.vm</span> contains a single function named <span class="code">Sys.init</span>. This function calls the  <span class="code">Main.fibonacci</span> function with <i>n</i>=4, and then loops indefinitely (the <span class="code">Sys.init</span> function, in turn, will be called by the VM implementation's bootstrap code).
</td>
<td>
<a onmouseover="popup(&quot;projects/08/FunctionCalls/FibonacciElement/FibonacciElementVME.tst&quot;,true);"> FibonacciElementVME.tst </a> 
<a onmouseover="popup(&quot;projects/08/FunctionCalls/FibonacciElement/FibonacciElement.tst&quot;,true);"> FibonacciElement.tst </a>
<a onmouseover="popup(&quot;projects/08/FunctionCalls/FibonacciElement/FibonacciElement.cmp&quot;,true);">
FibonacciElement.cmp</a>
<br><br>
Unlike the previous tests, this test assumes that the VM translator initializes the VM implementation.<br><br>If the generated assembly file will not begin with bootstrap code, the test will fail.
</td>

</tr>
<tr>
	<td> <u>StaticsTest:</u> <br> <span class="code">	
	<a onmouseover="popup(&quot;projects/08/FunctionCalls/StaticsTest/Class1.vm&quot;,true);"> Class1.vm </a>
	<br>
    <a onmouseover="popup(&quot;projects/08/FunctionCalls/StaticsTest/Class2.vm&quot;,true);"> Class2.vm </a>
    <br>
	<a onmouseover="popup(&quot;projects/08/FunctionCalls/StaticsTest/Sys.vm&quot;,true);"> Sys.vm </a>
</span>
</td>
	<td> <span class="code">Class1.vm</span> and <span class="code">Class2.vm</span> contain VM functions designed to set and get various static values; this is done in order to test the handling of the <span class="code">static</span> memory segment. <br><br> <span class="code">Sys.vm</span> contains a single <span class="code">Sys.init</span> function that calls the get/set functions of <span class="code">Class1</span> and <span class="code">Class2</span></td>
	<td> <a onmouseover="popup(&quot;projects/08/FunctionCalls/StaticsTest/StaticsTestVME.tst&quot;,true);">
StaticsTestVME.tst </a><br> <a onmouseover="popup(&quot;projects/08/FunctionCalls/StaticsTest/StaticsTest.tst&quot;,true);" target="_self"> StaticsTest.tst </a><br> <a onmouseover="popup(&quot;projects/08/FunctionCalls/StaticsTest/StaticsTest.cmp&quot;,true);"> StaticsTest.cmp </a>
<br><br>
This test assumes that the VM translator initializes the VM implementation; if the generated assembly file will not begin with bootstrap code, the test will fail.
</td> 
</tr>
</tbody></table>

<span class="project_desc">Proposed Implementation</span>

<p class="project_text">
<b>For each one of the five test programs, follow these steps:</b>
</p>

<ol>
<li> To get acquainted with the intended behavior of the supplied test program <span class="code">Xxx.vm</span>, run it on the supplied <i>VM emulator</i> using the supplied <span class="code">XxxVME.tst</span> script (if the program consists of one ore more files residing in a directory, load the entire directory into the <i>VM emulator</i> and proceed to execute the code).)</li>
<li> Use your <i>VM translator</i> to translate the supplied <span class="code">Xxx.vm</span> file, or directory, as needed. The result should be a new text file containing Hack assembly code. The name of this file should be <span class="code">Xxx.asm</span>.</li>
<li> Inspect the translated <span class="code">Xxx.asm</span> program. If there are visible syntax (or any other) errors, debug and fix your <i>VM translator</i>.  </li>
<li> To check if the translated code performs properly, use the supplied <span class="code">Xxx.tst</span> and <span class="code">Xxx.cmp</span> files to run the translated <span class="code">Xxx.asm</span> program on the supplied <i>CPU emulator</i>. If there are any problems, debug and fix your VM translator.</li> 
</ol>

<p class="project_text">
<b>API:</b> Chapter 8 includes a proposed, language-independent <i>VM translator API</i>. This API can serve as your implementation's blueprint.
</p>

<p class="project_text">
<b>Implementation order:</b> The supplied test programs were carefully planned to test the incremental features introduced by each stage in your VM implementation. Therefore, it's important to implement your <i>VM translator</i> in the proposed order, and to test it using the supplied test programs at each stage. Implementing a later stage before an early one may cause the test programs to fail.
</p>

<p class="project_text">
<b>Initialization:</b> In order for the translated VM code to execute on the host computer platform, the translated code stream (written in the machine language of the host platform) must include some bootstrap code that maps the stack on the host RAM and starts executing the code proper. The first three test programs in this project assume that the bootstrap code was not yet implemented, and include test scripts that effect the necessary initializations (as was done in project 7). The last two test programs assume that the bootstrap code is generated by the VM translator. In other words, the assembly code that the final version of your VM translator generates must start with some code that sets the stack pointer and calls the <tt>Sys.init</tt> function. <tt>Sys.init</tt> will then call the <tt>Main.main</tt> function, and the program will start running (similar to how Java's JVM always looks for, and starts executing, a method named <tt>main</tt>).
</p>

<span class="project_desc">Tools</span>

<p class="project_text">
Before setting out to extend your basic VM translator, we recommend playing with the supplied <span class="code">.vm</span> test programs. This will allow you to experiment with branching and function call-and-return commands, using the supplied <i>VM emulator</i>.
</p>

<p class="project_text">
<b>The VM emulator:</b> This Java program, which should be in your <span class="code">nand2tetris/tools</span> directory, is designed to execute VM programs in a direct and visual way, without having to first translate them into machine language. For example, you can use the supplied VM emulator to see - literally speaking - how one function calls another, and how the called function does its act and returns a value to the caller. For more information, see the <i>VM emulator tutorial</i> (<a href="http://nand2tetris.org/tutorials/PPT/VM%20Emulator%20Tutorial.ppt" target="_blank"><img align="ABSMIDDLE" src="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/powerpoint.gif" alt="PowerPoint Format" width="16" height="16"></a> <a href="http://nand2tetris.org/tutorials/PDF/VM%20Emulator%20Tutorial.pdf" target="_blank"><img align="ABSMIDDLE" src="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/acrobat.gif" alt="Portable Document Format" width="16" height="16"></a> ). 
</p>

<span class="project_text">
Here is a typical screen shot of the VM emulator in action:
<p></p>

<p class="project_text">
<img src="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/VM Emulator.gif"></p>

<p class="project_text">

			</p></span></div>
		</div>
		<div class="small">
			Best viewed with 
							<img src="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/compatible_firefox.gif">
							<img src="./The Elements of Computing Systems _ Nisan &amp; Schocken_files/compatible_chrome.gif"><br>
			Designed and built by Tali Gutman ©
		</div>
	
	
</body></html>