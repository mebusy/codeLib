#!bash

alias tma='tmux attach-session -t '
alias tmd='tmux detach -s '

# 2 horizontal panes
myT2() {
    # read arguments to an array
    local args=("$@")
    # if no arguments, use current directory
    if [ ${#args[@]} -eq 0 ]; then
        args=("$PWD")
    fi

    local _mainName=$(basename "$PWD")
    
    local session=""
    for _path in "${args[@]}"; do
        _path=$(realpath "$_path")
        local _name=$(basename "$_path")
        session="${session}${_name}·"
    done
    # remove last character (·)
    session=${session%·}

    # echo $session
    # if session already exists, kill it
    if tmux has-session -t "$session" 2>/dev/null; then
        echo "Session $session already exists"
        # tmux kill-session -t "$session"
        return 1
    fi

    #Create a new detached session
    tmux new-session -d -s $session -n $_mainName

    # for each path in args, convert to absolute path
    local i=0
    for _path in "${args[@]}"; do
        _path=$(realpath "$_path")
        # cd "$_path" || { echo "Failed to change directory to $_path"; return 1; }
        local _name=$(basename "$_path")
        echo $i, $_name, $_path

        local pane_session="$session:$i"
        if [ $i -gt 0 ]; then
            echo "Creating new window for $_name"
            tmux new-window -t "$pane_session" -n "$_name"
        fi
        # Split window into two horizontal panes
        tmux split-window -h -t "$pane_session"
        # cd to _path for all panes
        tmux send-keys -t "${pane_session}.0" "cd '$_path'" C-m
        tmux send-keys -t "${pane_session}.1" "cd '$_path'" C-m

        # select first pane
        tmux select-pane -t "${pane_session}.0"

        i=$((i + 1))
    done

    # Return to first window
    tmux select-window -t "$session:0"
    # Attach to the session
    tmux attach -t $session
}

myT4() {
    SESSION_NAME="dev4"

    # 参数：
    # $1 上左
    # $2 上右
    # $3 下左
    # $4 下右

    DIR_TL="$1"
    DIR_TR="$2"
    DIR_BL="$3"
    DIR_BR="$4"

    # 如果 session 已存在就直接进入
    tmux has-session -t "$SESSION_NAME" 2>/dev/null
    if [ $? -eq 0 ]; then
        tmux attach -t "$SESSION_NAME"
        exit 0
    fi

    # 创建 session
    tmux new-session -d -s "$SESSION_NAME"

    # 当前只有 pane 0  <Leader> + q

    # ---------- 第一步：左右 1:1 ----------
    tmux split-window -h -t "$SESSION_NAME":0

    # 此时：
    # pane 0 = 左
    # pane 1 = 右

    # ---------- 第二步：左侧上下 2:1 ----------
    tmux split-window -v -p 33 -t "$SESSION_NAME":0.0
    # pane 0 = 上左
    # pane 1 = 下左
    # pane 2 = 右

    # ---------- 第三步：右侧上下 2:1 ----------
    tmux split-window -v -p 33 -t "$SESSION_NAME":0.2

    # 0 | 2
    # 1 | 3
    #
    # ---------- 设置目录 ----------
    [ -n "$DIR_TL" ] && tmux send-keys -t "$SESSION_NAME":0.0 "cd \"$DIR_TL\"" C-m
    [ -n "$DIR_TR" ] && tmux send-keys -t "$SESSION_NAME":0.2 "cd \"$DIR_TR\"" C-m
    [ -n "$DIR_BL" ] && tmux send-keys -t "$SESSION_NAME":0.1 "cd \"$DIR_BL\"" C-m
    [ -n "$DIR_BR" ] && tmux send-keys -t "$SESSION_NAME":0.3 "cd \"$DIR_BR\"" C-m

    # 焦点回到左上
    tmux select-pane -t "$SESSION_NAME":0.0

    tmux attach -t "$SESSION_NAME"
}
